<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2D kollision i planet</title>
  <style>
    body {margin:0;font-family:system-ui,Arial,sans-serif;background:#121212;color:#e0e0e0;}
    .wrap {display:flex;height:100vh;}
    .left {width:40%;padding:12px;border-right:1px solid #333;box-sizing:border-box;overflow:auto;background:#1e1e1e;}
    .right {width:60%;padding:12px;box-sizing:border-box;overflow:auto;background:#1e1e1e;display:flex;flex-direction:column;gap:10px;}
    .author-note {text-align: center;font-size: 0.8rem;opacity: 0.6;margin-bottom: 6px;}

    h2,h3{margin:10px 0;}
    .row {display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:10px 0;}
    label {font-size:0.85rem;opacity:0.95;display:flex;flex-direction:column;gap:4px;}
    input {width:140px;box-sizing:border-box;background:#2a2a2a;color:#e0e0e0;border:1px solid #444;padding:8px;border-radius:6px;}
    input.small{width:110px;}
    button {padding:10px 14px;background:#333;color:#e0e0e0;border:1px solid #555;cursor:pointer;border-radius:8px;}
    button:hover {background:#444;}
    button:disabled{opacity:0.6;cursor:not-allowed;}

    #status {font-size:0.9rem;opacity:0.9;}
    .card {border:1px solid #333;background:#181818;border-radius:10px;padding:10px;margin:10px 0;}
    .puck-list {display:flex;flex-direction:column;gap:8px;}
    .puck-item {display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px solid #333;background:#171717;border-radius:10px;padding:8px;}
    .puck-item code {font-size:0.85rem;opacity:0.95;}
    .hint {font-size:0.9rem;opacity:0.9;}

    #simArea {flex:1;border:1px solid #333;background:#111;border-radius:12px;display:grid;place-items:center;overflow:hidden;padding:10px;}
    #simArea img {max-width:100%;height:auto;display:block;border-radius:10px;}
    .topbar {display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <div class="author-note">Utvecklat av Joel Utsi & Linus Andersson</div>
    <h2>Puckdata</h2>

    <div class="row">
      <button id="simulateBtn" disabled>Simulera!</button>
      <span id="status">Laddar Python…</span>
    </div>

    <div class="card">
      <h3>Rum</h3>
      <div class="row">
        <label>Friktion (μ)<input id="friction" type="number" step="0.01" value="0.10"/></label>
        <label>Simuleringstid (s)<input id="T" type="number" step="0.1" value="5.0"/></label>
      </div>
    </div>

    <div class="card">
      <h3>Puck</h3>
      <div class="row">
        <label>pos x <input id="px" class="small" type="number" step="0.1" value="-1.0"></label>
        <label>pos y <input id="py" class="small" type="number" step="0.1" value="-1.0"></label>
        <label>radie <input id="pr" class="small" type="number" step="0.01" value="0.15"></label>
        <label>massa <input id="pm" class="small" type="number" step="0.01" value="1.0"></label>
        <label>e <input id="pcor" class="small" type="number" step="0.01" value="0.30"></label>
        <label>vx <input id="pvx" class="small" type="number" step="0.1" value="2.0"></label>
        <label>vy <input id="pvy" class="small" type="number" step="0.1" value="2.0"></label>
        <button id="addPuckBtn">Lägg till puck</button>
      </div>
      <div class="hint">Lägger till puck med position, radie, massa, stöttal och begynnelsehastighet.</div>
      <h3 style="margin-top:12px;">Puckar</h3>
      <div id="puckList" class="puck-list"></div>
    </div>
  </div>

  <div class="right">
    <div class="topbar">
      <h2 style="margin:0;">Simulation</h2>
      <div class="hint" id="simHint">Lägg till puckar och tryck på Simulera!.</div>
    </div>
    <div id="simArea"><div class="hint">Ingen animation ännu.</div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

<script>
const statusEl = document.getElementById("status");
const simulateBtn = document.getElementById("simulateBtn");
const addPuckBtn = document.getElementById("addPuckBtn");
const puckListEl = document.getElementById("puckList");
const simHintEl = document.getElementById("simHint");
const simAreaEl = document.getElementById("simArea");

let pyodide = null;
let pucks = [];

function isFiniteNumber(x){ return Number.isFinite(x); }
function readNum(id){
  const v = Number(document.getElementById(id).value);
  return isFiniteNumber(v) ? v : null;
}

function renderPuckList(){
  puckListEl.innerHTML = "";
  if (!pucks.length){
    puckListEl.innerHTML = `<div class="hint">Inga puckar än.</div>`;
    return;
  }
  pucks.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="puck-item";
    d.innerHTML=`<code>P${i+1} pos=(${p.x.toFixed(2)},${p.y.toFixed(2)}) r=${p.radius.toFixed(2)} m=${p.mass.toFixed(2)} v=(${p.vx.toFixed(2)},${p.vy.toFixed(2)})</code>
                 <button>Ta bort</button>`;
    d.querySelector("button").onclick=()=>{pucks.splice(i,1);renderPuckList();};
    puckListEl.appendChild(d);
  });
}

addPuckBtn.onclick=()=>{
  const x=readNum("px"),y=readNum("py"),r=readNum("pr"),m=readNum("pm"),
        e=readNum("pcor"),vx=readNum("pvx"),vy=readNum("pvy");
  if([x,y,r,m,e,vx,vy].some(v=>v===null)) return;
  pucks.push({x,y,radius:r,mass:m,cor:e,vx,vy});
  renderPuckList();
};

async function initPyodideAndPackages(){
  pyodide=await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.29.0/full/"});
  await pyodide.loadPackage(["numpy","matplotlib","pillow"]);

  pyodide.runPython(`
import math, base64, os
from matplotlib import pyplot as plt
from matplotlib.animation import FuncAnimation, PillowWriter
from matplotlib.patches import Circle

DT=0.002
FPS=24

def simulate_to_media_base64(pucks_data, friction, T):
    pucks=[]
    for p in pucks_data:
        pucks.append(dict(x=p["x"],y=p["y"],vx=p["vx"],vy=p["vy"],r=p["radius"]))

    steps=int(T/DT)
    k=max(1,steps//int(T*FPS))
    frames=[]
    for s in range(steps+1):
        if s%k==0:
            frames.append([(p["x"],p["y"]) for p in pucks])
        for p in pucks:
            p["x"]+=p["vx"]*DT
            p["y"]+=p["vy"]*DT

    radii=[p["r"] for p in pucks]
    span=max(max(abs(x)+r for fr in frames for (x,_),r in zip(fr,radii)),
             max(abs(y)+r for fr in frames for (_,y),r in zip(fr,radii)))

    fig,ax=plt.subplots(figsize=(6,4),dpi=140)
    ax.set_facecolor("#0f1115")
    fig.patch.set_facecolor("#0f1115")
    ax.set_xlim(-span,span);ax.set_ylim(-span,span)
    ax.set_xticks([]);ax.set_yticks([])
    for sp in ax.spines.values(): sp.set_visible(False)

    circles=[];labels=[]
    label_pad=0.15*max(radii)
    for i,r in enumerate(radii):
        c=Circle((0,0),r,fill=False,linewidth=2,color="#e6e6e6")
        ax.add_patch(c);circles.append(c)
        t=ax.text(0,0,f"P{i+1}",ha="center",va="bottom",fontsize=9,color="#eaeaea")
        labels.append(t)

    def update(i):
        for j,(x,y) in enumerate(frames[i]):
            circles[j].center=(x,y)
            labels[j].set_position((x,y+radii[j]+label_pad))
        return circles+labels

    anim=FuncAnimation(fig,update,frames=len(frames),interval=1000/FPS,blit=True)
    out="/tmp/sim.gif"
    anim.save(out,writer=PillowWriter(fps=FPS))
    plt.close(fig)

    with open(out,"rb") as f: data=f.read()
    os.remove(out)
    return {"gif_b64":base64.b64encode(data).decode()}
  `);

  statusEl.textContent="Redo.";
  simulateBtn.disabled=false;
}

let simRunId=0;
simulateBtn.onclick=async()=>{
  if(!pucks.length) return;
  simRunId++; const runId=simRunId;
  simulateBtn.disabled=true;
  simAreaEl.innerHTML=`<div class="hint">Renderar…</div>`;
  pyodide.globals.set("pucks_js",pyodide.toPy(pucks));
  pyodide.globals.set("friction_js",readNum("friction"));
  pyodide.globals.set("T_js",readNum("T"));
  const res=(await pyodide.runPythonAsync("simulate_to_media_base64(pucks_js,friction_js,T_js)"))
            .toJs({dict_converter:Object.fromEntries});
  if(runId!==simRunId) return;
  simAreaEl.innerHTML=`<img src="data:image/gif;base64,${res.gif_b64}">`;
  simulateBtn.disabled=false;
};

renderPuckList();
initPyodideAndPackages();
</script>
</body>
</html>
